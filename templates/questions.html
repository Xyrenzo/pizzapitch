<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Опросник</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/quiz.css">
  </head>
  <body>
    {% include "header.html" %}
    <div class="container">
      <div class="quiz-box">
        <div class="header">
          <h2>Опросник</h2>
          <p class="subtitle">Ответьте на вопросы, чтобы узнать свой тип</p>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="quizContent"></div>
      </div>
    </div>

    <script>
      const questions = [
        {
          question: "Что тебе интереснее делать в компании?",
          options: [
            { text: "Организовать игру или активность.", type: "A" },
            { text: "Знакомить людей, поддерживать беседу.", type: "B" },
            { text: "Придумывать общую идею для мероприятия.", type: "C" },
            { text: "Распределять задачи и следить за временем.", type: "D" },
          ],
        },
        {
          question: "Какой отдых для тебя идеален?",
          options: [
            { text: "Поход с палаткой, спортивный забег.", type: "A" },
            { text: "Большая вечеринка или посиделки с друзьями.", type: "B" },
            {
              text: "Мастер-класс по рисованию или музыкальный концерт.",
              type: "C",
            },
            {
              text: "Спокойный вечер за планированием будущей поездки.",
              type: "D",
            },
          ],
        },
        {
          question: "Твой подход к решению проблемы?",
          options: [
            { text: "Сразу пробую разные способы на практике.", type: "A" },
            {
              text: "Обсуждаю с кем-то, чтобы найти решение вместе.",
              type: "B",
            },
            { text: "Ищу необычный, творческий способ.", type: "C" },
            {
              text: "Составляю план действий и анализирую возможные результаты.",
              type: "D",
            },
          ],
        },
        {
          question: "Какую книгу или фильм ты выберешь?",
          options: [
            {
              text: "Приключения, спорт, документалистика о природе.",
              type: "A",
            },
            {
              text: "Драма, романтика, история отношений между персонажами.",
              type: "B",
            },
            { text: "Фэнтези, научная фантастика, арт-хаус.", type: "C" },
            {
              text: "Детектив, бизнес-литература, историческая хроника.",
              type: "D",
            },
          ],
        },
        {
          question: "Что важнее в работе?",
          options: [
            {
              text: "Видеть реальный, осязаемый результат своего труда.",
              type: "A",
            },
            {
              text: "Помогать другим, общаться, работать в команде.",
              type: "B",
            },
            {
              text: "Иметь свободу для самовыражения и творчества.",
              type: "C",
            },
            {
              text: "Четкая структура, понятные задачи и карьерный рост.",
              type: "D",
            },
          ],
        },
        {
          question:
            "Если бы ты получил(-а) большую сумму денег, что сделал(-а) бы в первую очередь?",
          options: [
            {
              text: "Купил(-а) что-то для хобби (велосипед, гитару) или поехал(-а) в активный тур.",
              type: "A",
            },
            {
              text: "Устроил(-а) грандиозную вечеринку для всех друзей.",
              type: "B",
            },
            {
              text: "Вложил(-а) в свое образование или творческий проект.",
              type: "C",
            },
            {
              text: "Открыл(-а) вклад в банке или составил(-а) финансовый план.",
              type: "D",
            },
          ],
        },
        {
          question: "Как ты учишься чему-то новому?",
          options: [
            { text: "Сразу пробую делать, учусь на своих ошибках.", type: "A" },
            {
              text: "Записываюсь на курсы в группе, чтобы было веселее.",
              type: "B",
            },
            { text: "Ищу нестандартные подходы, экспериментирую.", type: "C" },
            {
              text: "Внимательно читаю инструкцию, составляю конспект.",
              type: "D",
            },
          ],
        },
        {
          question: "Что тебя мотивирует?",
          options: [
            { text: "Соревновательный дух, желание быть первым.", type: "A" },
            { text: "Признание и благодарность от других людей.", type: "B" },
            { text: "Возможность создать что-то уникальное.", type: "C" },
            {
              text: "Четко поставленная цель и план по ее достижению.",
              type: "D",
            },
          ],
        },
        {
          question: "Твои сильные стороны в учебе?",
          options: [
            { text: "Лабораторные работы, физкультура, черчение.", type: "A" },
            {
              text: "Подготовка презентаций, групповые проекты, дебаты.",
              type: "B",
            },
            {
              text: "Сочинения, проекты по искусству, нестандартные задачи.",
              type: "C",
            },
            {
              text: "Решение задач по алгоритму, подготовка к тестам.",
              type: "D",
            },
          ],
        },
        {
          question: "Как ты относишься к правилам?",
          options: [
            {
              text: "Считаю их нужными, но люблю проверять их на прочность.",
              type: "A",
            },
            { text: "Правила важны для комфортного общения.", type: "B" },
            {
              text: "Часто вижу, как их можно улучшить или нарушить ради идеи.",
              type: "C",
            },
            {
              text: "Правила созданы для того, чтобы их соблюдать. Это основа порядка.",
              type: "D",
            },
          ],
        },
        {
          question: "Что тебе интереснее в новостях?",
          options: [
            { text: "Новости спорта, технологий, происшествия.", type: "A" },
            { text: "Светская хроника, истории о людях.", type: "B" },
            {
              text: "Анонсы культурных событий, новые фильмы и музыка.",
              type: "C",
            },
            { text: "Аналитика экономики и политики.", type: "D" },
          ],
        },
        {
          question: "Твоя роль в групповом проекте?",
          options: [
            {
              text: "Тот, кто делает самую сложную практическую часть.",
              type: "A",
            },
            {
              text: "Координатор общения, который всех объединяет.",
              type: "B",
            },
            { text: "Генератор идей и дизайнер.", type: "C" },
            { text: "Составитель плана и ответственный за сроки.", type: "D" },
          ],
        },
        {
          question: "Что для тебя важнее в общении?",
          options: [
            { text: "Делать что-то вместе, а не много говорить.", type: "A" },
            { text: "Получать эмоциональный отклик и поддержку.", type: "B" },
            {
              text: "Обмениваться креативными идеями и вдохновлять.",
              type: "C",
            },
            {
              text: "Обсуждать факты и приходить к логичному выводу.",
              type: "D",
            },
          ],
        },
        {
          question: "Как ты справляешься со стрессом?",
          options: [
            { text: "Иду на пробежку или в спортзал.", type: "A" },
            {
              text: "Встречаюсь с друзьями и рассказываю им о проблеме.",
              type: "B",
            },
            {
              text: "Занимаюсь творчеством (музыка, рисование, письмо).",
              type: "C",
            },
            { text: "Составляю подробный план действий.", type: "D" },
          ],
        },
        {
          question: "Какой гаджет тебе ближе?",
          options: [
            {
              text: "Фитнес-трекер или мощный инструмент (дрель, мясорубка).",
              type: "A",
            },
            {
              text: "Качественная камера для селфи и видео-звонков.",
              type: "B",
            },
            {
              text: "Графический планшет или мощный компьютер для творчества.",
              type: "C",
            },
            {
              text: "Органайзер или приложение для учета финансов.",
              type: "D",
            },
          ],
        },
        {
          question: "Что бы ты хотел(-а) улучшить в мире?",
          options: [
            { text: "Создать более прочные и удобные вещи.", type: "A" },
            { text: "Научить людей лучше понимать друг друга.", type: "B" },
            { text: "Сделать мир красивее и вдохновляющее.", type: "C" },
            {
              text: "Сделать системы управления более эффективными.",
              type: "D",
            },
          ],
        },
        {
          question: "Каким был твой любимый предмет в школе?",
          options: [
            { text: "Физкультура, труд, черчение.", type: "A" },
            { text: "Литература, история, обществознание.", type: "B" },
            { text: "Музыка, ИЗО, информатика.", type: "C" },
            { text: "Математика, физика, экономика.", type: "D" },
          ],
        },
        {
          question: "Кем ты был(-а) в школьные годы в группе друзей?",
          options: [
            { text: "Инициатором подвижных игр.", type: "A" },
            { text: "Душой компании, тем, кто всех мирит.", type: "B" },
            { text: "Самым необычным, выдумщиком.", type: "C" },
            {
              text: "Голосом разума, кто всегда помнит о дедлайнах.",
              type: "D",
            },
          ],
        },
        {
          question: 'Что для тебя значит "успех"?',
          options: [
            {
              text: "Побить свой рекорд, достичь мастерства в деле.",
              type: "A",
            },
            { text: "Быть окруженным верными друзьями и семьей.", type: "B" },
            {
              text: "Реализовать свой уникальный творческий замысел.",
              type: "C",
            },
            { text: "Построить надежную и стабильную жизнь.", type: "D" },
          ],
        },
        {
          question:
            "На что ты обращаешь внимание в первую очередь, знакомясь с новым человеком?",
          options: [
            { text: "На его активность, энергию, осанку.", type: "A" },
            {
              text: "На его манеру общения, чувство юмора, открытость.",
              type: "B",
            },
            {
              text: "На его стиль, необычные детали, творческий подход.",
              type: "C",
            },
            {
              text: "На его логику, грамотность речи, умение аргументировать.",
              type: "D",
            },
          ],
        },
      ];

      let currentQuestion = 0;
      let answers = { A: 0, B: 0, C: 0, D: 0 };
      let userAnswers = Array(questions.length).fill(null);

      async function loadProgressFromServer(userId) {
        try {
          const response = await fetch(`/get_progress?user_id=${userId}`);
          if (response.ok) {
            const progress = await response.json();
            if (progress) {
              currentQuestion = progress.current_question || 0;
              answers = progress.answers || { A: 0, B: 0, C: 0, D: 0 };
              userAnswers =
                progress.user_answers || Array(questions.length).fill(null);

              // Восстанавливаем ответы в вопросах
              questions.forEach((q, idx) => {
                if (userAnswers[idx]) {
                  q.selectedAnswer = userAnswers[idx];
                }
              });
            }
          }
        } catch (error) {
          console.error("Error loading progress:", error);
        }

        renderQuestion();
      }

      async function saveProgressToServer() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        if (userId) {
          try {
            const progressData = {
              current_question: currentQuestion,
              answers: answers,
              user_answers: userAnswers,
            };

            await fetch("/save_progress?user_id=" + userId, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(progressData),
            });
          } catch (error) {
            console.error("Error saving progress:", error);
          }
        }
      }

      function renderQuestion() {
        const content = document.getElementById("quizContent");
        const question = questions[currentQuestion];

        content.innerHTML = `
              <div class="question-container active">
                  <div class="question-number">Вопрос ${
                    currentQuestion + 1
                  } из ${questions.length}</div>
                  <div class="question-text">${question.question}</div>
                  <div class="options">
                      ${question.options
                        .map(
                          (opt, idx) => `
                          <div class="option ${
                            question.selectedAnswer === opt.type
                              ? "selected"
                              : ""
                          }"
                               onclick="selectOption(${idx}, '${opt.type}')">
                              ${opt.text}
                          </div>
                      `
                        )
                        .join("")}
                  </div>
                  <div class="navigation">
                      <button class="btn btn-prev" onclick="prevQuestion()" ${
                        currentQuestion === 0 ? "disabled" : ""
                      }>
                          Назад
                      </button>
                      <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()" ${
                        !question.selectedAnswer ? "disabled" : ""
                      }>
                          ${
                            currentQuestion === questions.length - 1
                              ? "Завершить"
                              : "Далее"
                          }
                      </button>
                  </div>
              </div>
          `;

        updateProgress();
      }

      function selectOption(index, type) {
        const options = document.querySelectorAll(".option");
        options.forEach((opt) => opt.classList.remove("selected"));
        options[index].classList.add("selected");

        const question = questions[currentQuestion];

        // Убираем предыдущий ответ из подсчета
        if (question.selectedAnswer && question.selectedAnswer !== type) {
          answers[question.selectedAnswer]--;
        }

        // Добавляем новый ответ
        question.selectedAnswer = type;
        answers[type]++;
        userAnswers[currentQuestion] = type;

        document.getElementById("nextBtn").disabled = false;
        saveProgressToServer();
      }

      async function nextQuestion() {
        const question = questions[currentQuestion];
        if (!question.selectedAnswer) return;

        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          await saveProgressToServer();
          renderQuestion();
        } else {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("user_id");

            console.log("Final answers:", answers);

            const response = await fetch("/process_results?user_id=" + userId, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(answers),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Received data:", data);

            window.location.href = `/results?user_id=${userId}`;
          } catch (error) {
            console.error("Error:", error);
            window.location.href = `/results?user_id=${userId}`;
          }
        }
      }

      async function prevQuestion() {
        if (currentQuestion > 0) {
          const currentQ = questions[currentQuestion];
          const prevQ = questions[currentQuestion - 1];

          // Убираем текущий ответ из подсчета
          if (currentQ.selectedAnswer) {
            answers[currentQ.selectedAnswer]--;
            currentQ.selectedAnswer = null;
          }

          currentQuestion--;

          // Восстанавливаем предыдущий ответ в подсчете
          if (prevQ.selectedAnswer) {
            answers[prevQ.selectedAnswer]++;
          }

          await saveProgressToServer();
          renderQuestion();
        }
      }
      // Обновляем функцию showResultsPage
      function showResultsPage(data) {
        const hasImage =
          data.image && data.image.startsWith("data:image/png;base64");
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        // Определяем доминирующий тип для редиректа
        const dominantType = getDominantType(data.results);
        let redirectUrl = "/A";
        if (dominantType.includes("Коммуникатор-организатор"))
          redirectUrl = "/B";
        if (dominantType.includes("Творец-иноватор")) redirectUrl = "/C";
        if (dominantType.includes("Аналитик-стратег")) redirectUrl = "/D";

        const content = document.getElementById("quizContent");
        content.innerHTML = `
              <div class="question-container active">
                  <div class="question-number">Результаты теста</div>
                  <div class="question-text">Ваш психологический тип</div>

                  ${
                    hasImage
                      ? `
                      <div style="text-align: center; margin: 30px 0;">
                          <img src="${data.image}" alt="График результатов"
                               style="max-width: 100%; max-height: 400px; border-radius: 15px;
                                      box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 3px solid #ffd700;">
                      </div>
                  `
                      : `
                      <div style="text-align: center; margin: 20px 0; color: #ff6b6b;">
                          <p>⚠️ Не удалось создать график, но вот ваши результаты:</p>
                      </div>
                  `
                  }

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0;">
                      <div class="result-type" style="background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #FF6B6B;">
                          <div style="font-weight: bold; color: #FF6B6B; font-size: 16px; margin-bottom: 8px;">Практик-деятель</div>
                          <div style="font-size: 28px; font-weight: bold; color: #FF6B6B;">${
                            data.results.A
                          }</div>
                          <div style="font-size: 12px; color: #666; margin-top: 5px;">Тебе важно видеть результаты своих усилий, ты энергичен и ориентирован на действие. Не боишься физ. труда и любишь, когда работа кипит.</div>
                      </div>
                      <div class="result-type" style="background: linear-gradient(135deg, rgba(78,205,196,0.15), rgba(78,205,196,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #4ECDC4;">
                          <div style="font-weight: bold; color: #4ECDC4; font-size: 16px; margin-bottom: 8px;">Коммуникатор-организатор</div>
                          <div style="font-size: 28px; font-weight: bold; color: #4ECDC4;">${
                            data.results.B
                          }</div>
                          <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты - мастер общения. Тебе легко находить общий язык с людьми, ты умеешь вдохновлять, убеждать и помогать. Работа в команде - твоя стихия.</div>
                      </div>
                      <div class="result-type" style="background: linear-gradient(135deg, rgba(69,183,209,0.15), rgba(69,183,209,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #45B7D1;">
                          <div style="font-weight: bold; color: #45B7D1; font-size: 16px; margin-bottom: 8px;">Творец-иноватор</div>
                          <div style="font-size: 28px; font-weight: bold; color: #45B7D1;">${
                            data.results.C
                          }</div>
                          <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты обладаешь ярким воображением и нестандартным мышлением. Тебе важно создавать что-то новое, выражать свои идеи и менять мир вокруг через творчество и инновации</div>
                      </div>
                      <div class="result-type" style="background: linear-gradient(135deg, rgba(150,206,180,0.15), rgba(150,206,180,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #96CEB4;">
                          <div style="font-weight: bold; color: #96CEB4; font-size: 16px; margin-bottom: 8px;">Аналитик-стратег</div>
                          <div style="font-size: 28px; font-weight: bold; color: #96CEB4;">${
                            data.results.D
                          }</div>
                          <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты - логик и стратег. Тебе нравится работать с информацией, цифрами и схемами. Ты ценишь порядок, точность и любишь докапываться до сути вещи.</div>
                      </div>
                  </div>

                  <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1)); padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffd700;">
                      <div style="font-weight: bold; color: #2d2d2d; margin-bottom: 10px;">📈 Ваш основной тип:</div>
                      <div style="font-size: 18px; font-weight: bold; color: #ffa500;">
                          ${getDominantType(data.results)}
                      </div>
                  </div>

                  <div class="navigation">
                      <button class="btn btn-prev" onclick="location.reload()" style="flex: 1;">
                          🔄 Пройти заново
                      </button>
                      <button class="btn btn-next" onclick="window.location.href='${redirectUrl}?user_id=${userId}'" style="flex: 1;">
                          🎯 Посмотреть профессии
                      </button>
                  </div>
              </div>
          `;

        document.querySelector(".progress-bar").style.display = "none";
      }

      // Функция для определения доминирующего типа
      function getDominantType(results) {
        if (!results) return "Не определен";

        const maxCount = Math.max(
          results.A || 0,
          results.B || 0,
          results.C || 0,
          results.D || 0
        );
        const dominantTypes = [];

        if ((results.A || 0) === maxCount)
          dominantTypes.push("Практик-деятель");
        if ((results.B || 0) === maxCount)
          dominantTypes.push("Коммуникатор-организатор");
        if ((results.C || 0) === maxCount)
          dominantTypes.push("Творец-иноватор");
        if ((results.D || 0) === maxCount)
          dominantTypes.push("Аналитик-стратег");

        return dominantTypes.join(", ");
      }

      function prevQuestion() {
        if (currentQuestion > 0) {
          const question = questions[currentQuestion];
          if (question.selectedAnswer) {
            answers[question.selectedAnswer]--;
          }
          currentQuestion--;
          renderQuestion();
        }
      }

      function updateProgress() {
        const progress = ((currentQuestion + 1) / questions.length) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
      }

      function highlightActivePage() {
        console.log("=== highlightActivePage started ===");
        const currentPath = window.location.pathname;
        console.log("currentPath:", currentPath);

        const navLinks = document.querySelectorAll(".nav-link");
        console.log("navLinks found:", navLinks.length);

        navLinks.forEach((link, index) => {
          let linkPath = link.getAttribute("href").split("?")[0];

          // Убираем слеши в конце для нормального сравнения
          linkPath = linkPath.replace(/\/+$/, "");
          const cleanCurrentPath = currentPath.replace(/\/+$/, "");

          console.log(`Link ${index}:`, {
            fullHref: link.getAttribute("href"),
            pathOnly: linkPath,
            currentPath: cleanCurrentPath,
            matches: linkPath === cleanCurrentPath,
          });

          if (linkPath === cleanCurrentPath) {
            console.log("ADDING active class to:", link.textContent);
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
        console.log("=== highlightActivePage finished ===");
      }
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        // Загружаем прогресс из БД через сервер
        loadProgressFromServer(userId);
        highlightActivePage();
        renderQuestion();
      });
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Подтверждение почты</title>
    <link rel="stylesheet" href="/static/css/base.css" />
    <link rel="stylesheet" href="/static/css/auth.css" />
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        padding: 20px;
      }

      .verify-box {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 50px 40px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3),
          0 0 40px rgba(255, 215, 0, 0.2), 0 0 60px rgba(255, 215, 0, 0.1),
          0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .verify-box::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ffd700, #ffa500, #ffd700, #ffa500);
        border-radius: 20px;
        z-index: -1;
        animation: glow 3s ease-in-out infinite;
        opacity: 0.6;
      }

      @keyframes glow {
        0%,
        100% {
          opacity: 0.6;
        }
        50% {
          opacity: 0.8;
        }
      }

      h2 {
        text-align: center;
        color: #2d2d2d;
        margin-bottom: 10px;
        font-size: 32px;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3),
          0 0 20px rgba(255, 215, 0, 0.2);
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 40px;
        font-size: 15px;
        line-height: 1.5;
      }

      .subtitle strong {
        color: #2d2d2d;
        font-weight: 600;
      }

      .code-inputs {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 35px 0;
      }

      .code-inputs input {
        width: 60px;
        height: 70px;
        text-align: center;
        font-size: 28px;
        font-weight: 600;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        color: #2d2d2d;
        outline: none;
        transition: all 0.3s ease;
      }

      .code-inputs input:focus {
        border-color: #ffd700;
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1),
          0 0 15px rgba(255, 215, 0, 0.3), 0 0 30px rgba(255, 215, 0, 0.2),
          0 0 45px rgba(255, 215, 0, 0.1);
        transform: scale(1.05);
      }

      .code-inputs input.error {
        border-color: #ff4444;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .error-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-150px);
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        color: white;
        padding: 18px 30px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.6),
          0 0 30px rgba(255, 68, 68, 0.4), 0 0 45px rgba(255, 68, 68, 0.2),
          0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .error-notification::before {
        content: "⚠️";
        font-size: 20px;
      }

      .error-notification.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      @keyframes errorGlow {
        0%,
        100% {
          box-shadow: 0 0 15px rgba(255, 68, 68, 0.6),
            0 0 30px rgba(255, 68, 68, 0.4), 0 0 45px rgba(255, 68, 68, 0.2),
            0 8px 32px rgba(0, 0, 0, 0.3);
        }
        50% {
          box-shadow: 0 0 20px rgba(255, 68, 68, 0.8),
            0 0 40px rgba(255, 68, 68, 0.6), 0 0 60px rgba(255, 68, 68, 0.3),
            0 8px 32px rgba(0, 0, 0, 0.3);
        }
      }

      .error-notification.visible {
        animation: errorGlow 2s ease-in-out infinite;
      }

      .loading-indicator {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .loading-indicator.visible {
        opacity: 1;
      }

      .loading-indicator::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }

      .resend-code {
        text-align: center;
        margin-top: 30px;
        color: #666;
        font-size: 14px;
      }

      .resend-code button {
        background: none;
        border: none;
        color: #ffd700;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        padding: 0;
        font-size: 14px;
      }

      .resend-code button:hover {
        color: #ffa500;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.5),
          0 0 30px rgba(255, 215, 0, 0.3);
      }

      .resend-code button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @media (max-width: 600px) {
        .verify-box {
          padding: 40px 30px;
        }

        h2 {
          font-size: 28px;
        }

        .code-inputs {
          gap: 8px;
        }

        .code-inputs input {
          width: 48px;
          height: 60px;
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="error-notification" id="errorNotification">
      Неверный код. Попробуйте снова
    </div>

    <div class="verify-box">
      <h2>Подтверждение почты</h2>
      <p class="subtitle">
        Введите 6-значный код, отправленный на<br />
        <strong>{{ email }}</strong>
      </p>

      <div class="code-inputs" id="codeInputs">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
      </div>

      <div class="loading-indicator" id="loadingIndicator">Проверка кода</div>

      <div class="resend-code">
        Не получили код? <button id="resendBtn">Отправить заново</button>
      </div>
    </div>

    <script>
      const inputs = document.querySelectorAll("#codeInputs input");
      const errorNotification = document.getElementById("errorNotification");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const resendBtn = document.getElementById("resendBtn");
      const email = "{{ email }}";
      const userId = "{{ user_id }}";
      let isVerifying = false;

      inputs.forEach((input, idx) => {
        // Разрешаем только цифры
        input.addEventListener("input", (e) => {
          const value = input.value.replace(/[^0-9]/g, "");
          input.value = value.slice(0, 1);

          if (value && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }

          const code = Array.from(inputs)
            .map((i) => i.value)
            .join("");
          if (code.length === 6) {
            verifyCode(code);
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace") {
            if (!input.value && idx > 0) {
              inputs[idx - 1].focus();
              inputs[idx - 1].value = "";
            }
          }
          if (e.key === "ArrowLeft" && idx > 0) {
            inputs[idx - 1].focus();
          }
          if (e.key === "ArrowRight" && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }
        });

        input.addEventListener("paste", (e) => {
          e.preventDefault();
          const pasted = e.clipboardData
            .getData("text")
            .replace(/[^0-9]/g, "")
            .slice(0, 6);

          pasted.split("").forEach((char, i) => {
            if (inputs[idx + i]) {
              inputs[idx + i].value = char;
            }
          });

          const lastFilledIndex = Math.min(idx + pasted.length, inputs.length);
          if (lastFilledIndex < inputs.length) {
            inputs[lastFilledIndex].focus();
          }

          const code = Array.from(inputs)
            .map((i) => i.value)
            .join("");
          if (code.length === 6) {
            verifyCode(code);
          }
        });
      });

      async function verifyCode(code) {
        if (isVerifying) return;
        isVerifying = true;
        loadingIndicator.classList.add("visible");
        document.body.style.cursor = "wait";

        const formData = new FormData();
        formData.append("email", email);
        formData.append("code", code);
        formData.append("user_id", userId);

        try {
          const res = await fetch("/verify_code", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.success) {
            window.location.href = data.redirect_url;
          } else {
            showError();
          }
        } catch {
          showError();
        } finally {
          isVerifying = false;
          loadingIndicator.classList.remove("visible");
          document.body.style.cursor = "default";
        }
      }

      function showError() {
        inputs.forEach((i) => {
          i.value = "";
          i.classList.add("error");
        });

        errorNotification.classList.add("visible");

        setTimeout(() => {
          inputs.forEach((i) => i.classList.remove("error"));
        }, 500);

        setTimeout(() => {
          errorNotification.classList.remove("visible");
        }, 3000);

        inputs[0].focus();
      }

      resendBtn.addEventListener("click", async () => {
        if (resendBtn.disabled) return;

        resendBtn.disabled = true;
        resendBtn.textContent = "Отправка...";

        const formData = new FormData();
        formData.append("email", email);

        try {
          const res = await fetch("/resend_code", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();

          if (data.success) {
            resendBtn.textContent = "Отправлено!";
          } else {
            resendBtn.textContent = "Ошибка отправки";
            console.error(data.message || "Ошибка при повторной отправке");
          }
        } catch (err) {
          resendBtn.textContent = "Ошибка сети";
        }

        setTimeout(() => {
          resendBtn.textContent = "Отправить заново";
          resendBtn.disabled = false;
        }, 60000); // 60 секунд таймаут
      });

      inputs[0].focus();
    </script>
  </body>
</html>

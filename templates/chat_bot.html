<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareerGuide - Чат-бот</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/chat.css">
  </head>
  <body>
    {% include "header.html" %}

    <div class="container">
      <!-- Боковая панель с чатами (только десктоп) -->
      <div class="chats-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Мои чаты</div>
          <button class="new-chat-btn" onclick="createNewChat()">
            + Новый
          </button>
        </div>
        <div class="chats-list" id="chatsList">
          <div class="no-chats">Создайте первый чат</div>
        </div>
      </div>

      <!-- Основная область чата -->
      <div class="chat-main">
        <div class="chat-header">
          <h1 class="chat-title-main">CareerGuide Assistant</h1>
          <p class="chat-subtitle">Ваш персональный карьерный консультант</p>
        </div>

        <div class="messages-container" id="messagesContainer">
          <div class="empty-state">
            Выберите чат или создайте новый, чтобы начать общение
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>

        <div class="input-container">
          <textarea
            class="message-input"
            id="messageInput"
            placeholder="Напишите ваш вопрос о карьере или профессиональном развитии..."
            rows="1"
            onkeydown="handleKeydown(event)"
          ></textarea>
          <button
            class="send-btn"
            id="sendBtn"
            onclick="sendMessage()"
            disabled
          >
            Отправить
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentChatId = null;
      let chats = [];
      const urlParams = new URLSearchParams(window.location.search);
      const currentUserId = urlParams.get("user_id") || 1;

      // Отрисовка списка чатов
      function renderChatsList() {
        const chatsList = document.getElementById("chatsList");
        if (chats.length === 0) {
          chatsList.innerHTML = '<div class="no-chats">Создайте первый чат</div>';
          return;
        }
        chatsList.innerHTML = chats
          .map(
            (chat) => `
        <div class="chat-item ${currentChatId === chat.id ? "active" : ""}" 
             onclick="setActiveChat(${chat.id})">
            <div class="chat-title">${chat.title}</div>
            <div class="chat-date">${formatDate(chat.updated_at)}</div>
            <button class="delete-chat" onclick="deleteChat(${chat.id}, event)">×</button>
        </div>
    `
          )
          .join("");
        
        // Синхронизируем с мобильным меню
        renderMobileChatsList();
      }

      // Загрузка списка чатов
      async function loadChats() {
        try {
          console.log("Loading chats for user:", currentUserId);
          const response = await fetch(`/chat/chats?user_id=${currentUserId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Chats response:", data);
          if (data.status === "success") {
            chats = data.chats;
            renderChatsList();
            if (data.active_chat) {
              setActiveChat(data.active_chat.id);
            } else if (chats.length > 0) {
              setActiveChat(chats[0].id);
            }
          }
        } catch (error) {
          console.error("Error loading chats:", error);
          showError("Ошибка загрузки чатов");
        }
      }

      // Установка активного чата
      async function setActiveChat(chatId) {
        try {
          console.log("Setting active chat:", chatId, "for user:", currentUserId);
          const response = await fetch(
            `/chat/${chatId}/set_active?user_id=${currentUserId}`,
            { method: "POST" }
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Set active response:", data);
          if (data.status === "success") {
            currentChatId = chatId;
            renderChatsList();
            loadMessages();
          }
        } catch (error) {
          console.error("Error setting active chat:", error);
          showError("Ошибка установки активного чата");
        }
      }

      // Загрузка сообщений
      async function loadMessages() {
        if (!currentChatId) return;
        try {
          console.log("Loading messages for user:", currentUserId);
          const response = await fetch(`/chat/messages?user_id=${currentUserId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Messages response:", data);
          if (data.status === "success") {
            renderMessages(data.messages);
          }
        } catch (error) {
          console.error("Error loading messages:", error);
          showError("Ошибка загрузки сообщений");
        }
      }

      // Отрисовка сообщений
      function renderMessages(messages) {
        const messagesContainer = document.getElementById("messagesContainer");
        if (messages.length === 0) {
          messagesContainer.innerHTML = '<div class="empty-state">Начните общение с CareerGuide</div>';
          return;
        }
        messagesContainer.innerHTML = messages
          .map(
            (msg) => `
        <div class="message ${msg.role}">
            <div class="message-content">${msg.content}</div>
            <div class="message-time">${formatTime(msg.created_at)}</div>
        </div>
    `
          )
          .join("");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Создание нового чата
      async function createNewChat() {
        try {
          console.log("Creating new chat for user:", currentUserId);
          const response = await fetch(`/chat/create?user_id=${currentUserId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: "Новый чат" }),
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Create chat response:", data);
          if (data.status === "success") {
            await loadChats();
            setActiveChat(data.chat_id);
          }
        } catch (error) {
          console.error("Error creating chat:", error);
          showError("Ошибка создания чата");
        }
      }

      // Удаление чата
      async function deleteChat(chatId, event) {
        event.stopPropagation();
        if (!confirm("Вы уверены, что хотите удалить этот чат?")) return;
        try {
          console.log("Deleting chat:", chatId, "for user:", currentUserId);
          const response = await fetch(`/chat/${chatId}?user_id=${currentUserId}`, {
            method: "DELETE",
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Delete response:", data);
          if (data.status === "success") {
            await loadChats();
          }
        } catch (error) {
          console.error("Error deleting chat:", error);
          showError("Ошибка удаления чата");
        }
      }

      // Отправка сообщения
      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message || !currentChatId) return;

        addMessageToChat("user", message);
        input.value = "";
        updateSendButton();
        showTypingIndicator();

        try {
          console.log("Sending message for user:", currentUserId, "Message:", message);
          const response = await fetch(`/chat/send?user_id=${currentUserId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Send message response:", data);
          hideTypingIndicator();
          if (data.status === "success") {
            await loadMessages();
            await loadChats();
          } else {
            addMessageToChat("assistant", "Извините, произошла ошибка. Попробуйте еще раз.");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          hideTypingIndicator();
          addMessageToChat("assistant", "Извините, произошла ошибка соединения.");
        }
      }

      function addMessageToChat(role, content) {
        const messagesContainer = document.getElementById("messagesContainer");
        const emptyState = messagesContainer.querySelector(".empty-state");
        if (emptyState) emptyState.remove();
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;
        messageDiv.innerHTML = `
        <div class="message-content">${content}</div>
        <div class="message-time">${formatTime(new Date().toISOString())}</div>
    `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTypingIndicator() {
        document.getElementById("typingIndicator").style.display = "block";
        const messagesContainer = document.getElementById("messagesContainer");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTypingIndicator() {
        document.getElementById("typingIndicator").style.display = "none";
      }

      function handleKeydown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
        updateSendButton();
      }

      function updateSendButton() {
        const input = document.getElementById("messageInput");
        const button = document.getElementById("sendBtn");
        button.disabled = !input.value.trim() || !currentChatId;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("ru-RU");
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString("ru-RU", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function highlightActivePage() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => {
          const linkPath = link.getAttribute("href").split("?")[0];
          if (linkPath === currentPath) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      function showError(message) {
        const messagesContainer = document.getElementById("messagesContainer");
        const errorDiv = document.createElement("div");
        errorDiv.className = "message assistant error";
        errorDiv.innerHTML = `
        <div class="message-content" style="color: #ff6b6b;">${message}</div>
        <div class="message-time">${formatTime(new Date().toISOString())}</div>
    `;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      document.getElementById("messageInput").addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
        updateSendButton();
      });

      document.addEventListener("DOMContentLoaded", function () {
        console.log("Current user ID:", currentUserId);
        loadChats();
        highlightActivePage();
      });
    </script>

    <!-- ===== МОБИЛЬНАЯ АДАПТАЦИЯ ДЛЯ СПИСКА ЧАТОВ ===== -->
    <script>
      (function() {
        function initMobileChatMenu() {
          // НЕ СОЗДАЕМ на десктопе
          if (window.innerWidth > 768) return;
          if (document.getElementById('chatsBurgerBtn')) return;

          // Кнопка бургера
          const burgerBtn = document.createElement('button');
          burgerBtn.id = 'chatsBurgerBtn';
          burgerBtn.className = 'chats-burger-btn';
          burgerBtn.innerHTML = `
            <span class="chats-burger-line"></span>
            <span class="chats-burger-line"></span>
            <span class="chats-burger-line"></span>
          `;
          document.body.appendChild(burgerBtn);

          // Мобильное меню
          const mobileMenu = document.createElement('div');
          mobileMenu.id = 'chatsMobileMenu';
          mobileMenu.className = 'chats-mobile-menu';
          const menuHeader = document.createElement('div');
          menuHeader.className = 'sidebar-header';
          menuHeader.innerHTML = `
            <div class="sidebar-title">Мои чаты</div>
            <button class="new-chat-btn" onclick="createNewChatMobile()">+ Новый</button>
          `;
          mobileMenu.appendChild(menuHeader);
          const chatsList = document.createElement('div');
          chatsList.id = 'chatsMobileList';
          chatsList.className = 'chats-list';
          chatsList.innerHTML = '<div class="no-chats">Создайте первый чат</div>';
          mobileMenu.appendChild(chatsList);
          document.body.appendChild(mobileMenu);

          // Оверлей
          const overlay = document.createElement('div');
          overlay.id = 'chatsOverlay';
          overlay.className = 'chats-overlay';
          document.body.appendChild(overlay);

          setupMobileChatMenuEvents();
        }

        function setupMobileChatMenuEvents() {
          const burgerBtn = document.getElementById('chatsBurgerBtn');
          const mobileMenu = document.getElementById('chatsMobileMenu');
          const overlay = document.getElementById('chatsOverlay');
          const chatMain = document.querySelector('.chat-main');
          const body = document.body;

          if (!burgerBtn || !mobileMenu || !overlay) return;

          function toggleChatMenu() {
            const isActive = mobileMenu.classList.contains('active');
            if (!isActive) {
              burgerBtn.classList.add('active');
              mobileMenu.classList.add('active');
              overlay.classList.add('active');
              if (chatMain) chatMain.classList.add('pushed');
              body.style.overflow = 'hidden';
            } else {
              closeChatMenu();
            }
          }

          window.closeChatMenu = function() {
            burgerBtn.classList.remove('active');
            mobileMenu.classList.remove('active');
            overlay.classList.remove('active');
            if (chatMain) chatMain.classList.remove('pushed');
            body.style.overflow = '';
          };

          burgerBtn.addEventListener('click', toggleChatMenu);
          overlay.addEventListener('click', closeChatMenu);

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
              closeChatMenu();
            }
          });

          window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
              if (mobileMenu.classList.contains('active')) {
                closeChatMenu();
              }
              removeMobileElements();
            } else {
              initMobileChatMenu();
            }
          });
        }

        function removeMobileElements() {
          const burgerBtn = document.getElementById('chatsBurgerBtn');
          const mobileMenu = document.getElementById('chatsMobileMenu');
          const overlay = document.getElementById('chatsOverlay');
          
          if (burgerBtn) burgerBtn.remove();
          if (mobileMenu) mobileMenu.remove();
          if (overlay) overlay.remove();
        }

        window.renderMobileChatsList = function() {
          const mobileList = document.getElementById('chatsMobileList');
          if (!mobileList) return;

          if (chats.length === 0) {
            mobileList.innerHTML = '<div class="no-chats">Создайте первый чат</div>';
            return;
          }

          mobileList.innerHTML = chats
            .map(
              (chat) => `
            <div class="chat-item ${currentChatId === chat.id ? "active" : ""}" 
                 onclick="setActiveChatMobile(${chat.id})">
                <div class="chat-title">${chat.title}</div>
                <div class="chat-date">${formatDate(chat.updated_at)}</div>
                <button class="delete-chat" onclick="deleteChatMobile(${chat.id}, event)">×</button>
            </div>
          `
            )
            .join("");
        };

        window.createNewChatMobile = async function() {
          await createNewChat();
          setTimeout(() => {
            if (window.closeChatMenu) window.closeChatMenu();
          }, 300);
        };

        window.setActiveChatMobile = async function(chatId) {
          await setActiveChat(chatId);
          setTimeout(() => {
            if (window.closeChatMenu) window.closeChatMenu();
          }, 300);
        };

        window.deleteChatMobile = async function(chatId, event) {
          event.stopPropagation();
          await deleteChat(chatId, event);
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            if (window.innerWidth <= 768) {
              initMobileChatMenu();
            }
          });
        } else {
          if (window.innerWidth <= 768) {
            initMobileChatMenu();
          }
        }
        
        setTimeout(() => {
          if (window.innerWidth <= 768) {
            initMobileChatMenu();
          }
        }, 100);
      })();
    </script>
  </body>
</html>